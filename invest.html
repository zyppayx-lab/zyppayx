<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zyppayxvest | Invest</title>
<style>
body { margin:0; font-family: Arial, Helvetica, sans-serif; background:#f6f8fb;}
header { background:#0a1f44;color:#fff;padding:20px;text-align:center;font-size:20px;}
.container { max-width:1100px;margin:auto;padding:15px;}
.card { background:#fff;padding:18px;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);}
.card h3 { margin:0 0 10px 0; font-size:16px; color:#0a1f44;}
.card p { margin:4px 0; font-size:14px; color:#666;}
.card img { width:100%; border-radius:12px; margin-bottom:10px;}
.amount-input { width:100%; padding:10px; margin-top:8px; border-radius:8px; border:1px solid #ddd; font-size:14px;}
.quick-amounts { display:flex; gap:10px; margin-top:8px;}
.quick-amounts button { flex:1; padding:10px; border:none; border-radius:8px; background:#00c896; color:#fff; cursor:pointer;}
button.main-btn { margin-top:10px; padding:12px; background:#0a1f44; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:bold; width:100%;}
.loader-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; z-index:1000; flex-direction:column;}
.loader { border:6px solid #f3f3f3; border-top:6px solid #00c896; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite;}
@keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
.success-tick { display:none; color:#00c896; font-size:50px; animation:scaleUp 0.5s forwards; margin-top:10px;}
@keyframes scaleUp { 0% { transform:scale(0); } 100% { transform:scale(1); } }
nav { position:fixed; bottom:0; width:100%; background:#fff; border-top:1px solid #ddd; display:flex; justify-content:space-around; padding:10px 0;}
nav a { text-decoration:none; color:#555; font-size:13px; text-align:center;}
nav a.active { color:#00c896; font-weight:bold;}
</style>
<script src="https://js.paystack.co/v1/inline.js"></script>
</head>
<body>

<header>Choose an Investment Plan</header>
<div class="container" id="plansContainer">
  <p>Loading investment plans...</p>
</div>

<div class="loader-overlay" id="loader">
  <div class="loader"></div>
  <p style="color:#fff; margin-top:10px;">Processing payment...</p>
  <div class="success-tick" id="successTick">&#10003;</div>
</div>

<nav>
  <a href="dashboard.html">Home</a>
  <a href="invest.html" class="active">Invest</a>
  <a href="refer.html">Refer</a>
  <a href="alert.html">Alerts</a>
  <a href="profile.html">Profile</a>
</nav>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, doc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCQ8TCMUAySwLSBN3-0W1GV4XWateS1rqQ",
  authDomain: "zyppayx-69c54.firebaseapp.com",
  projectId: "zyppayx-69c54",
  storageBucket: "zyppayx-69c54.firebasestorage.app",
  messagingSenderId: "439535581166",
  appId: "1:439535581166:web:994d1c9f75bd1294ef00ff"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const PAYSTACK_KEY = "pk_live_d52baea87b2c4e49b110aa5cda32260b33b0cb35";
let currentUserId = "", currentUserEmail = "";

// ================== AUTH CHECK ==================
onAuthStateChanged(auth, async (user) => {
  if (!user) { window.location.href = "login.html"; return; }
  currentUserId = user.uid;
  currentUserEmail = user.email;
  loadPlans();
});

// ================== LOAD INVESTMENT PLANS ==================
async function loadPlans() {
  const plansRef = collection(db, "investmentPlans");
  const snap = await getDocs(plansRef);
  const container = document.getElementById("plansContainer");
  container.innerHTML = "";

  if (snap.empty) { container.innerHTML = "<p>No investment plans available.</p>"; return; }

  snap.forEach(planDoc => {
    const plan = planDoc.data();
    if (plan.status !== "active") return;

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <img src="${plan.image}" onerror="this.src='placeholder.png';">
      <h3>${plan.title}</h3>
      <p>Duration: ${plan.duration} days</p>
      <p>Daily Return: ₦${plan.dailyReturn}</p>
      <p>Total Return: ₦${plan.totalReturn}</p>
      <p>Minimum Amount: ₦${plan.minAmount}</p>
      <input class="amount-input" placeholder="Enter amount ≥ ${plan.minAmount}" type="number" min="${plan.minAmount}" />
      <div class="quick-amounts">
        <button>₦${plan.minAmount}</button>
        <button>₦${plan.minAmount*2}</button>
        <button>₦${plan.minAmount*5}</button>
      </div>
      <button class="main-btn">Invest</button>
    `;

    const input = card.querySelector(".amount-input");

    // Quick buttons
    card.querySelectorAll(".quick-amounts button").forEach(btn => {
      btn.onclick = () => { input.value = btn.textContent.replace("₦",""); }
    });

    // Invest button
    card.querySelector(".main-btn").onclick = () => {
      const amt = Number(input.value);
      if (!amt || amt < plan.minAmount) { alert(`Enter amount ≥ ₦${plan.minAmount}`); return; }
      invest(plan, amt);
    };

    container.appendChild(card);
  });
}

// ================== LOADER ==================
function showLoader(show) {
  const loader = document.getElementById("loader");
  loader.style.display = show ? "flex" : "none";
  if (!show) document.getElementById("successTick").style.display = "none";
}

// ================== INVEST FUNCTION ==================
function invest(plan, amount) {
  showLoader(true);
  PaystackPop.setup({
    key: PAYSTACK_KEY,
    email: currentUserEmail,
    amount: amount * 100,  // kobo
    currency: "NGN",
    callback: async function(response) {
      // Record investment in Firebase (manual mode)
      const invRef = collection(db, "users", currentUserId, "investments");
      await addDoc(invRef, {
        planId: plan.title,
        amount,
        dailyReturn: plan.dailyReturn,
        totalReturn: plan.totalReturn,
        duration: plan.duration,
        status: "active",
        createdAt: serverTimestamp(),
        paystackRef: response.reference
      });
      document.getElementById("successTick").style.display = "block";
      setTimeout(() => showLoader(false), 1500);
    },
    onClose: function() {
      showLoader(false);
      alert("Payment cancelled");
    }
  }).openIframe();
}
</script>
</body>
</html>
