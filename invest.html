<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zyppayxvest | My Investments</title>
<style>
body { font-family: Arial; background:#f6f8fb; margin:0; padding:20px;}
.card { background:#fff; padding:16px; border-radius:14px; margin-bottom:20px; box-shadow:0 4px 12px rgba(0,0,0,0.05);}
.card h4 { margin:0 0 8px 0; color:#0a1f44; }
.card p { margin:4px 0; color:#333; font-size:14px; }
.lock { color:#e74c3c; font-weight:bold; }
.ready { color:#00c896; font-weight:bold; }
button { width:100%; padding:12px; border:none; border-radius:10px; margin-top:8px; cursor:pointer; }
.disabled { background:#ccc; cursor:not-allowed; }
.active { background:#00c896; color:#fff; }
img.plan-img { width:100%; border-radius:12px; margin-bottom:8px; object-fit:cover; max-height:150px; }
</style>
</head>
<body>

<h2 style="text-align:center;">My Active Investments</h2>
<div id="investmentsContainer">Loading investments...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, getDocs, query, where, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCQ8TCMUAySwLSBN3-0W1GV4XWateS1rqQ",
  authDomain: "zyppayx-69c54.firebaseapp.com",
  projectId: "zyppayx-69c54"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const container = document.getElementById("investmentsContainer");

onAuthStateChanged(auth, async user => {
  if (!user) { window.location.href = "login.html"; return; }
  loadActiveInvestments(user.uid);
});

async function loadActiveInvestments(uid){
  container.innerHTML = "Loading investments...";
  
  const invQuery = query(
    collection(db, "investments"),
    where("userId", "==", uid),
    where("status", "==", "active")
  );

  const snap = await getDocs(invQuery);
  container.innerHTML = "";

  if (snap.empty) {
    container.innerHTML = "<p style='text-align:center;'>No active investments.</p>";
    return;
  }

  snap.forEach(docSnap => {
    const inv = docSnap.data();

    const card = document.createElement("div");
    card.className = "card";

    const timer = document.createElement("p");
    const btn = document.createElement("button");
    btn.textContent = "Withdraw";
    btn.className = "disabled";
    btn.disabled = true;

    // Countdown update
    function updateCountdown() {
      const now = Date.now();
      const diff = inv.endDate - now;

      if (diff <= 0) {
        timer.innerHTML = "<span class='ready'>Investment matured</span>";
        btn.disabled = false;
        btn.className = "active";
        btn.onclick = () => alert("Withdraw flow here");
      } else {
        const d = Math.floor(diff / 86400000);
        const h = Math.floor((diff % 86400000) / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        const s = Math.floor((diff % 60000) / 1000);
        timer.innerHTML = `<span class='lock'>Locked:</span> ${d}d ${h}h ${m}m ${s}s`;
      }
    }

    setInterval(updateCountdown, 1000);
    updateCountdown();

    card.innerHTML = `
      ${inv.planImage ? `<img src="${inv.planImage}" class="plan-img" onerror="this.src='placeholder.png'">` : ""}
      <h4>${inv.planName}</h4>
      <p>Amount: â‚¦${inv.amount}</p>
      <p>Duration: ${inv.duration} days</p>
      <p>Start: ${new Date(inv.startDate).toLocaleDateString()}</p>
      <p>End: ${new Date(inv.endDate).toLocaleDateString()}</p>
    `;
    card.appendChild(timer);
    card.appendChild(btn);
    container.appendChild(card);
  });
}
</script>

</body>
</html>
