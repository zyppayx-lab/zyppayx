<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zyppayxvest | Invest</title>

<style>
body{margin:0;font-family:Arial;background:#f6f8fb}
header{background:#0a1f44;color:#fff;padding:20px;text-align:center;font-size:20px}
.container{max-width:1100px;margin:auto;padding:15px}
.card{background:#fff;padding:18px;border-radius:14px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,.05)}
.card img{width:100%;border-radius:12px;margin-bottom:10px}
.card h3{margin:0;color:#0a1f44}
.card p{color:#666;font-size:14px}
.amount{width:100%;padding:12px;border-radius:10px;border:1px solid #ddd;margin-top:8px}
.quick{display:flex;gap:8px;margin-top:8px}
.quick button{flex:1;background:#00c896;color:#fff;border:none;padding:10px;border-radius:8px}
.main{margin-top:12px;background:#0a1f44;color:#fff;border:none;width:100%;padding:14px;border-radius:12px;font-weight:bold}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);align-items:center;justify-content:center;flex-direction:column;z-index:999}
.loader{width:45px;height:45px;border:5px solid #eee;border-top:5px solid #00c896;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.tick{display:none;font-size:50px;color:#00c896;margin-top:10px}
</style>

<script src="https://js.paystack.co/v1/inline.js"></script>
</head>

<body>

<header>Choose Investment Plan</header>

<div class="container" id="plans">
  <p>Loading plans...</p>
</div>

<div class="overlay" id="overlay">
  <div class="loader"></div>
  <p style="color:#fff;margin-top:10px">Processing payment...</p>
  <div class="tick" id="tick">✔</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCQ8TCMUAySwLSBN3-0W1GV4XWateS1rqQ",
  authDomain: "zyppayx-69c54.firebaseapp.com",
  projectId: "zyppayx-69c54"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const PAYSTACK_KEY = "pk_live_d52baea87b2c4e49b110aa5cda32260b33b0cb35";

let uid="", email="";

onAuthStateChanged(auth,user=>{
  if(!user){ location.href="login.html"; return; }
  uid=user.uid;
  email=user.email;
  loadPlans();
});

async function loadPlans(){
  const box=document.getElementById("plans");
  const snap=await getDocs(collection(db,"investmentPlans"));
  box.innerHTML="";

  snap.forEach(doc=>{
    const p=doc.data();
    if(p.status!=="active") return;

    const card=document.createElement("div");
    card.className="card";

    card.innerHTML=`
      <img src="${p.image}" onerror="this.style.display='none'">
      <h3>${p.title}</h3>
      <p>Duration: ${p.duration} days</p>
      <p>Minimum: ₦${p.minAmount}</p>

      <input class="amount" type="number" min="${p.minAmount}" placeholder="Enter amount ≥ ₦${p.minAmount}">
      <div class="quick">
        <button>₦${p.minAmount}</button>
        <button>₦${p.minAmount*2}</button>
        <button>₦${p.minAmount*5}</button>
      </div>
      <button class="main">Invest</button>
    `;

    const input=card.querySelector(".amount");
    card.querySelectorAll(".quick button").forEach(b=>{
      b.onclick=()=>input.value=b.textContent.replace("₦","");
    });

    card.querySelector(".main").onclick=()=>{
      const amt=Number(input.value);
      if(!amt || amt<p.minAmount){ alert("Enter valid amount"); return; }
      pay(p,amt);
    };

    box.appendChild(card);
  });
}

function show(v){
  document.getElementById("overlay").style.display=v?"flex":"none";
  document.getElementById("tick").style.display="none";
}

function pay(plan,amount){
  show(true);

  PaystackPop.setup({
    key: PAYSTACK_KEY,
    email,
    amount: amount*100,
    currency:"NGN",
    callback: async res=>{
      await addDoc(collection(db,"users",uid,"investments"),{
        plan: plan.title,
        amount,
        duration: plan.duration,
        status: "active",
        reference: res.reference,
        createdAt: Date.now()
      });

      document.getElementById("tick").style.display="block";
      setTimeout(()=>show(false),1500);
    },
    onClose: ()=>show(false)
  }).openIframe();
}
</script>

</body>
</html>
