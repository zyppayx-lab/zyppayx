<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Manual Payment</title>
<style>
body { font-family: Arial; background:#f6f8fb; padding:20px;}
.card { background:#fff; padding:20px; border-radius:12px; max-width:400px; margin:auto; box-shadow:0 4px 12px rgba(0,0,0,0.05);}
.card p { margin:12px 0;}
.copy-btn { background:#00c896; color:#fff; border:none; padding:6px 10px; border-radius:5px; cursor:pointer; margin-left:8px; font-size:12px;}
.submit-btn { margin-top:15px; padding:12px; width:100%; border:none; border-radius:8px; background:#0a1f44; color:#fff; cursor:pointer; font-weight:bold;}
</style>
</head>
<body>

<div class="card">
  <h3>Manual Payment Details</h3>
  <p>Bank Name: <span id="bankName"></span></p>
  <p>Account Number: <span id="accountNumber"></span> <button class="copy-btn" id="copyAcc">Copy</button></p>
  <p>Account Name: <span id="accountName"></span></p>
  <p>Amount to Pay: â‚¦<span id="payAmount"></span> <button class="copy-btn" id="copyAmt">Copy</button></p>
  <button class="submit-btn" id="submitBtn">I Have Paid</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCQ8TCMUAySwLSBN3-0W1GV4XWateS1rqQ",
  authDomain: "zyppayx-69c54.firebaseapp.com",
  projectId: "zyppayx-69c54"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// General account details
const generalAccount = {
  bankName: "Paystack-Titan",
  accountNumber: "9740116304",
  accountName: "MOREINFOPAY/Zyppayx"
};

// Get URL params
const params = new URLSearchParams(window.location.search);
const planId = params.get("planId");
const amount = params.get("amount");

// Display account info
document.getElementById("bankName").textContent = generalAccount.bankName;
document.getElementById("accountNumber").textContent = generalAccount.accountNumber;
document.getElementById("accountName").textContent = generalAccount.accountName;
document.getElementById("payAmount").textContent = amount;

// Copy buttons
document.getElementById("copyAcc").onclick = () => navigator.clipboard.writeText(generalAccount.accountNumber);
document.getElementById("copyAmt").onclick = () => navigator.clipboard.writeText(amount);

// Handle manual payment submission
onAuthStateChanged(auth, async user => {
  if (!user) { window.location.href = "login.html"; return; }

  document.getElementById("submitBtn").onclick = async () => {
    try {
      // Fetch plan details
      const planRef = doc(db, "investmentPlans", planId);
      const planSnap = await getDoc(planRef);
      if (!planSnap.exists()) { alert("Plan not found"); return; }
      const plan = planSnap.data();

      const startDate = Date.now();
      const endDate = startDate + (plan.duration * 24 * 60 * 60 * 1000); // convert days to ms

      // Add to top-level investments collection
      await addDoc(collection(db, "investments"), {
        planId: planId,
        planName: plan.title || "Plan",
        userId: user.uid,
        userEmail: user.email,
        amount: Number(amount),
        status: "pending",        // pending by default
        duration: plan.duration,
        startDate: startDate,
        endDate: endDate,
        createdAt: serverTimestamp()
      });

      alert("Investment recorded as pending! Admin will approve it.");
      window.location.href = "invest.html"; // redirect back
    } catch (err) {
      alert("Error recording investment: " + err.message);
    }
  };
});
</script>

</body>
</html>
