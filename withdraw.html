<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Withdraw – Zyppayx</title>

<style>
body{
  font-family:Arial;
  background:#000;
  margin:0;
  padding:0;
  color:#eee;
}
.box{
  background:#111;
  margin:30px 15px;
  padding:20px;
  border-radius:12px;
  box-shadow:0 2px 10px rgba(255,255,255,0.1);
}
h2{text-align:center;color:#bb86fc;}
input, select{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:8px;
  border:1px solid #555;
  background:#222;
  color:#eee;
}
button{
  width:100%;
  margin-top:15px;
  background:#bb86fc;
  color:#000;
  border:none;
  padding:12px;
  border-radius:8px;
  cursor:pointer;
}
button:hover{opacity:0.9}
.fee{margin-top:10px;color:#ccc}
.back{text-align:center;margin-top:15px;}
.back a{color:#bb86fc;text-decoration:none;}
</style>
</head>

<body>

<div class="box">
  <h2>Withdraw Funds</h2>

  <input type="number" id="amount" placeholder="Amount (₦500 - ₦10,000)">
  <div class="fee" id="feeText"></div>

  <select id="bank">
    <option value="">Select Bank</option>
    <!-- Commercial Banks -->
    <option>Access Bank</option>
    <option>Citibank</option>
    <option>Ecobank</option>
    <option>Fidelity Bank</option>
    <option>First Bank of Nigeria</option>
    <option>FCMB</option>
    <option>Globus Bank</option>
    <option>GTBank</option>
    <option>Heritage Bank</option>
    <option>Jaiz Bank</option>
    <option>Keystone Bank</option>
    <option>Union Bank</option>
    <option>UBA</option>
    <option>Unity Bank</option>
    <option>Wema Bank</option>
    <option>Zenith Bank</option>
    <option>Standard Chartered Bank</option>
    <option>Sterling Bank</option>
    <option>Stanbic IBTC Bank</option>
    <option>Titan Trust Bank</option>
    <option>PalmPay Bank</option>
    <!-- MFBs & Digital Banks -->
    <option>Kuda Bank</option>
    <option>Moniepoint MFB</option>
    <option>Rubies MFB</option>
    <option>SunTrust Bank</option>
    <option>TAJ Bank</option>
  </select>

  <input type="text" id="accountName" placeholder="Account Name">
  <input type="number" id="accountNumber" placeholder="Account Number">

  <button id="submitWithdraw">Submit Withdrawal</button>

  <div class="back">
    <a href="dashboard.html">← Back to Dashboard</a>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDaQrSeEcCIVOtQJwiEeS_86w11Hn-ITh8",
  authDomain: "zyppayx-57fbf.firebaseapp.com",
  projectId: "zyppayx-57fbf",
  storageBucket: "zyppayx-57fbf.appspot.com",
  messagingSenderId: "79547716710",
  appId: "1:79547716710:web:17287b4e064488020349a7"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const amountInput = document.getElementById("amount");
const feeText = document.getElementById("feeText");

amountInput.oninput = () => {
  const amt = Number(amountInput.value);
  feeText.innerText = amt ? `Withdrawal Fee (5%): ₦${(amt*0.05).toFixed(2)}` : "";
};

document.getElementById("submitWithdraw").onclick = async () => {
  const user = auth.currentUser;
  if(!user) { alert("Please login to withdraw"); return; }

  const amount = Number(amountInput.value);
  const bank = document.getElementById("bank").value;
  const accountName = document.getElementById("accountName").value.trim();
  const accountNumber = document.getElementById("accountNumber").value.trim();

  if(!amount || amount < 500 || amount > 10000) { 
    alert("Amount must be between ₦500 and ₦10,000"); return;
  }
  if(!bank || !accountName || !accountNumber){ alert("Please fill all fields"); return; }

  try {
    const userRef = db.collection("users").doc(user.uid);
    const userDoc = await userRef.get();
    if(!userDoc.exists) { alert("User not found"); return; }

    const userData = userDoc.data();
    const balance = userData.balance || 0;

    if(amount > balance){ alert("Insufficient balance"); return; }

    // Check daily total
    const today = new Date();
    const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate()+1);

    const dailyWithdrawals = await db.collection("withdrawals")
      .where("userId","==",user.uid)
      .where("createdAt",">=",startOfDay)
      .where("createdAt","<",endOfDay)
      .get();

    const dailyTotal = dailyWithdrawals.docs.reduce((sum, doc)=> sum + (doc.data().amount || 0),0);
    if(dailyTotal + amount > 50000){ alert("Daily withdrawal limit of ₦50,000 reached"); return; }

    const fee = amount * 0.05;

    // Add withdrawal request
    await db.collection("withdrawals").add({
      userId: user.uid,
      email: user.email,
      amount,
      fee,
      bank,
      accountName,
      accountNumber,
      status: "pending",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Deduct balance
    await userRef.update({ balance: balance - amount });

    alert("Withdrawal request sent successfully, you will be credited within 24 hours");

  } catch(err) {
    console.error(err);
    alert("Failed to submit withdrawal. Try again.");
  }
};
</script>

</body>
</html>
