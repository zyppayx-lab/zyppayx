<!DOCTYPE html>
<html>
<head>
  <title>Zyppayx Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #000; margin: 0; color: #eee; }
    .header { background: #6a0dad; color: #fff; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: relative; }
    .header-right { display: flex; align-items: center; gap: 15px; }
    .bell { cursor: pointer; font-size: 22px; position: relative; }
    .bell-count { position: absolute; top: -5px; right: -10px; background: red; border-radius: 50%; padding: 2px 6px; font-size: 12px; }
    button { background: #6a0dad; color: #fff; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; }
    button:hover { background: #580c9e; }
    .box { background: #111; margin: 15px; padding: 20px; border-radius: 12px; }
    .task-card { border-bottom: 1px solid #333; padding: 10px 0; }
    .promotion-card { flex: 0 0 auto; width: 200px; margin: 10px; }
    .promotion-card img { width: 100%; height: 120px; border-radius: 12px; object-fit: cover; cursor: pointer; }
    .banner img { width: 100%; height: 180px; border-radius: 12px; object-fit: cover; cursor: pointer; }
    .notification-panel { position: absolute; top: 55px; right: 15px; width: 300px; max-height: 350px; background: #111; border-radius: 12px; overflow-y: auto; z-index: 1000; box-shadow: 0 0 10px rgba(0,0,0,0.6); display: none; }
    .notification-item { padding: 12px; border-bottom: 1px solid #333; font-size: 14px; }
    .notification-item b { color: #bb86fc; }
    .footer { text-align: center; padding: 15px; font-size: 14px; color: #ccc; }
    .footer a { color: #bb86fc; text-decoration: none; }
    #promotionsWrapper { overflow-x: auto; display: flex; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
    .uploadStatus { font-size: 12px; color: #bb86fc; margin-top: 5px; }
    input.screenshotInput { margin-top: 10px; border-radius: 8px; padding: 5px; width: 90%; background: #222; color: #eee; border: 1px solid #555; }
  </style>
</head>
<body>

<div class="header">
  <b>Zyppayx</b>
  <div class="header-right">
    <span id="bell" class="bell">ðŸ””<span id="bellCount" class="bell-count">0</span></span>
    <button id="logoutBtn">Logout</button>
  </div>
  <div id="notificationPanel" class="notification-panel"></div>
</div>

<div class="box banner">
  <img id="bannerAd" src="" alt="Banner Ad">
</div>

<div class="box">
  <h3>Balance</h3>
  <p id="balance">â‚¦0</p>
  <button onclick="location.href='deposit.html'">Deposit</button>
  <button onclick="location.href='withdraw.html'">Withdraw</button>
  <p>Your referral link: <span id="refLink"></span></p>
</div>

<div class="box">
  <h3>Promotions</h3>
  <div id="promotionsWrapper"></div>
</div>

<div class="box">
  <h3>Tasks</h3>
  <div id="tasks"></div>
</div>

<div class="footer">
  Contact us: <a href="mailto:zyppayx@gmail.com">zyppayx@gmail.com</a>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDaQrSeEcCIVOtQJwiEeS_86w11Hn-ITh8",
  authDomain: "zyppayx-57fbf.firebaseapp.com",
  projectId: "zyppayx-57fbf",
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

const bell = document.getElementById("bell");
const bellCount = document.getElementById("bellCount");
const panel = document.getElementById("notificationPanel");
const bannerAd = document.getElementById("bannerAd");
const promotionsWrapper = document.getElementById("promotionsWrapper");

let promoData = [];
let currentPromoIndex = 0;

/* ---------- IMAGE COMPRESSION ---------- */
function compressImageToBase64(file, maxWidth=800, quality=0.6){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = ()=>{
      const img = new Image();
      img.src = reader.result;
      img.onload = ()=>{
        const canvas = document.createElement("canvas");
        const scale = Math.min(maxWidth/img.width,1);
        canvas.width = img.width*scale;
        canvas.height = img.height*scale;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        resolve(canvas.toDataURL("image/jpeg",quality).split(",")[1]);
      };
      img.onerror = reject;
    };
    reader.onerror = reject;
  });
}

/* ---------- AUTH & LOAD DASHBOARD ---------- */
auth.onAuthStateChanged(async user=>{
  if(!user) location.href="index.html";
  document.getElementById("refLink").innerText = `https://zyppayx.name.ng/?ref=${user.uid}`;

  // Balance
  const userDoc = await db.collection("users").doc(user.uid).get();
  document.getElementById("balance").innerText = "â‚¦" + (userDoc.data()?.balance || 0);

  // Banner Ad
  db.collection("banner_ads").doc("current").get().then(doc=>{
    if(doc.exists){
      bannerAd.src = doc.data().imgUrl || '';
      bannerAd.onclick = ()=>{ if(doc.data().link) window.open(doc.data().link,"_blank"); }
    }
  });

  // Promotions
  db.collection("promotions").orderBy("createdAt","desc").onSnapshot(snap=>{
    promotionsWrapper.innerHTML="";
    promoData=[];
    snap.forEach(doc=>{
      const p = doc.data();
      promoData.push(p);
      const div=document.createElement("div");
      div.className="promotion-card";
      div.innerHTML=`<img src="${p.imgUrl}" alt="${p.title}" onclick="window.open('${p.link}','_blank')">`;
      promotionsWrapper.appendChild(div);
    });
  });

  // Tasks
  const tasksDiv = document.getElementById("tasks");
  db.collection("tasks").where("status","==","active").onSnapshot(async snap=>{
    tasksDiv.innerHTML="";
    for(const d of snap.docs){
      const t = d.data();
      const submissionSnap = await db.collection("task-submissions")
        .where("userId","==",user.uid)
        .where("taskId","==",d.id)
        .get();
      const alreadySubmitted = !submissionSnap.empty;
      const taskCard = document.createElement("div");
      taskCard.className="task-card";
      taskCard.innerHTML=`
        <b>${t.title}</b>
        <p>${t.description}</p>
        <p>â‚¦${t.reward}</p>
        <a href="${t.taskLink}" target="_blank">Go to task</a><br><br>
        <input type="file" accept="image/*" class="screenshotInput" data-task-id="${d.id}" ${alreadySubmitted?"disabled":""}>
        <button class="uploadBtn" data-task-id="${d.id}" data-reward="${t.reward}" ${alreadySubmitted?"disabled":""}>
          ${alreadySubmitted?"Already Submitted":"Submit Screenshot"}
        </button>
        <p class="uploadStatus" data-task-id="${d.id}"></p>
      `;
      tasksDiv.appendChild(taskCard);
    }
  });

  // Notifications
  db.collection("notifications").where("userId","==",user.uid).orderBy("createdAt","desc").onSnapshot(snap=>{
    panel.innerHTML="";
    let unread=0;
    snap.forEach(doc=>{
      const n = doc.data();
      if(!n.read) unread++;
      panel.innerHTML+=`<div class="notification-item"><b>${n.title}</b><br>${n.message}</div>`;
    });
    bellCount.innerText=unread;
  });

  // Auto credit tasks
  db.collection("task-submissions").where("userId","==",user.uid).onSnapshot(async snap=>{
    for(const doc of snap.docs){
      const sub=doc.data();
      if(sub.status==="approved" && !sub.credited){
        await db.collection("users").doc(user.uid)
          .update({ balance: firebase.firestore.FieldValue.increment(sub.reward||0) });
        await doc.ref.update({ credited:true });
        await db.collection("notifications").add({
          userId:user.uid,
          title:"Task Approved",
          message:`Your task "${sub.taskId}" has been approved and credited.`,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          read:false
        });
      }
    }
  });

});

/* ---------- TASK SUBMISSION ---------- */
document.addEventListener("click", async e=>{
  if(!e.target.classList.contains("uploadBtn")) return;

  const btn=e.target;
  const taskId=btn.dataset.taskId;
  const reward=parseInt(btn.dataset.reward||0);
  const input=document.querySelector(`.screenshotInput[data-task-id="${taskId}"]`);
  const status=document.querySelector(`.uploadStatus[data-task-id="${taskId}"]`);

  if(!input.files[0]){
    alert("Select a screenshot first");
    return;
  }

  btn.disabled=true;
  status.innerText="Uploading...";

  try{
    const base64=await compressImageToBase64(input.files[0]);
    const user=auth.currentUser;
    const snap=await db.collection("task-submissions")
      .where("userId","==",user.uid)
      .where("taskId","==",taskId).get();
    if(!snap.empty){
      status.innerText="You already submitted this task!";
      return;
    }

    await db.collection("task-submissions").add({
      userId:user.uid,
      taskId,
      screenshotBase64:base64,
      status:"pending",
      reward,
      credited:false,
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    });

    status.innerText="âœ… Submitted successfully. Await review.";
    input.value="";
  }catch(err){
    console.error(err);
    status.innerText="âŒ Upload failed. Try again.";
    btn.disabled=false;
  }
});

/* ---------- UI ---------- */
bell.onclick=()=>{ panel.style.display = panel.style.display==="block"?"none":"block"; }
document.getElementById("logoutBtn").onclick=()=>auth.signOut().then(()=>location.href="index.html");

// Auto-scroll promotions
setInterval(()=>{
  if(promoData.length===0) return;
  currentPromoIndex=(currentPromoIndex+1)%promoData.length;
  const card=promotionsWrapper.children[currentPromoIndex];
  if(card) promotionsWrapper.scrollLeft=card.offsetLeft;
},5000);

</script>
</body>
</html>