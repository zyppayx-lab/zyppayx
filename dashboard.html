<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Zyppayx Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial; background: #000; margin: 0; color: #eee; }
.box { background: #111; margin: 15px; padding: 20px; border-radius: 12px; }
h2,h3 { color: #bb86fc; margin-bottom: 10px; }
button { background: #bb86fc; color: #000; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; margin: 5px 5px 0 0; }
button:hover { opacity: 0.9; }
.banner img { width: 100%; height: 180px; border-radius: 12px; object-fit: cover; cursor: pointer; margin-bottom: 15px; }
#promotionsWrapper { display: flex; overflow-x: auto; gap: 10px; scroll-behavior: smooth; }
#promotionsWrapper img { width: 200px; height: 120px; border-radius: 12px; object-fit: cover; cursor: pointer; }
#tasks .task-card { border-bottom: 1px solid #333; padding: 10px 0; }
#tasks .task-card input { margin-top: 10px; border-radius: 8px; padding: 5px; width: 90%; background: #222; color: #eee; border: 1px solid #555; }
#tasks .task-card button { margin-top: 5px; }
.uploadStatus { font-size: 12px; color: #bb86fc; margin-top: 5px; }
.bottom-nav { position: fixed; bottom: 0; width: 100%; background: #111; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #333; }
.bottom-nav button { flex: 1; margin: 0 5px; }
.profile-box p { margin: 8px 0; }
</style>
</head>
<body>

<!-- Dashboard Section -->
<div id="dashboardView">
  <div class="box banner">
    <img id="bannerAd" src="" alt="Banner Ad">
  </div>

  <div class="box">
    <h3>Balance</h3>
    <p id="balance">‚Ç¶0</p>
    <button onclick="location.href='deposit.html'">Deposit</button>
    <button onclick="location.href='withdraw.html'">Withdraw</button>
    <p>Referral link: <span id="refLink"></span></p>
  </div>

  <div class="box">
    <h3></h3>
    <div id="promotionsWrapper"></div>
  </div>

  <div class="box">
    <h3>Tasks</h3>
    <div id="tasks"></div>
  </div>

  <!-- Investments Section -->
  <div class="box">
    <h3>Active Investments</h3>
    <div id="investmentsList"></div>
  </div>
</div>

<!-- Profile Section -->
<div id="profileView" style="display:none;">
  <div class="box profile-box">
    <h3>Profile</h3>
    <p>Email: <span id="profileEmail"></span></p>
    <p>UID: <span id="profileUID"></span></p>
    <p>Contact: <a href="mailto:zyppayx@gmail.com">zyppayx@gmail.com</a></p>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<div class="bottom-nav">
  <button id="navDashboard">üè†</button>
  <button onclick="location.href='investment.html'">üí∞</button>
  <button id="navProfile">üë§</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDaQrSeEcCIVOtQJwiEeS_86w11Hn-ITh8",
  authDomain: "zyppayx-57fbf.firebaseapp.com",
  projectId: "zyppayx-57fbf",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const dashboardView = document.getElementById("dashboardView");
const profileView = document.getElementById("profileView");
const bannerAd = document.getElementById("bannerAd");
const balanceEl = document.getElementById("balance");
const refLink = document.getElementById("refLink");
const promotionsWrapper = document.getElementById("promotionsWrapper");
const tasksDiv = document.getElementById("tasks");
const investmentsList = document.getElementById("investmentsList");

auth.onAuthStateChanged(async user => {
  if(!user) location.href="index.html";

  document.getElementById("profileEmail").innerText = user.email;
  document.getElementById("profileUID").innerText = user.uid;
  document.getElementById("logoutBtn").onclick = ()=>auth.signOut().then(()=>location.href="index.html");

  refLink.innerText = `https://zyppayx.name.ng/?ref=${user.uid}`;

  const userDoc = await db.collection("users").doc(user.uid).get();
  let balance = userDoc.data()?.balance || 0;
  balanceEl.innerText = balance;

  const bannerDoc = await db.collection("banner_ads").doc("current").get();
  if(bannerDoc.exists){
    bannerAd.src = bannerDoc.data().imgUrl || '';
    bannerAd.onclick = ()=>{ if(bannerDoc.data().link) window.open(bannerDoc.data().link,"_blank"); }
  }

  db.collection("promotions").orderBy("createdAt","desc").onSnapshot(snap=>{
    promotionsWrapper.innerHTML="";
    snap.forEach(doc=>{
      const p = doc.data();
      const img = document.createElement("img");
      img.src = p.imgUrl;
      img.alt = p.title;
      img.onclick = ()=>{ if(p.link) window.open(p.link,"_blank"); }
      promotionsWrapper.appendChild(img);
    });
  });

  // Tasks
  db.collection("tasks").where("status","==","active").onSnapshot(async snap=>{
    tasksDiv.innerHTML="";
    for(const doc of snap.docs){
      const t = doc.data();
      const submissionSnap = await db.collection("task-submissions")
        .where("userId","==",user.uid)
        .where("taskId","==",doc.id).get();
      const alreadySubmitted = !submissionSnap.empty;

      const taskCard = document.createElement("div");
      taskCard.className="task-card";
      taskCard.innerHTML=`
        <b>${t.title}</b>
        <p>${t.description}</p>
        <p>‚Ç¶${t.reward}</p>
        <a href="${t.taskLink}" target="_blank">Go to task</a><br><br>
        <input type="file" accept="image/*" class="screenshotInput" data-task-id="${doc.id}" ${alreadySubmitted?"disabled":""}>
        <button class="uploadBtn" data-task-id="${doc.id}" data-reward="${t.reward}" ${alreadySubmitted?"disabled":""}>
          ${alreadySubmitted?"Already Submitted":"Submit Screenshot"}
        </button>
        <p class="uploadStatus" data-task-id="${doc.id}"></p>
      `;
      tasksDiv.appendChild(taskCard);
    }
  });

  // Auto-credit approved task submissions
  db.collection("task-submissions")
    .where("userId", "==", user.uid)
    .where("credited", "==", false)
    .onSnapshot(async snap => {
      for (const doc of snap.docs) {
        const submission = doc.data();
        if(submission.status === "approved") {
          const userRef = db.collection("users").doc(user.uid);
          await db.runTransaction(async tx => {
            const userDoc = await tx.get(userRef);
            const currentBalance = userDoc.data()?.balance || 0;
            tx.update(userRef, { balance: currentBalance + submission.reward });
            tx.update(doc.ref, { credited: true });
          });
          balanceEl.innerText = (Number(balanceEl.innerText.replace('‚Ç¶','')) + submission.reward).toFixed(2);
        }
      }
    });

  // Investments
  db.collection("userInvestments").where("userId","==",user.uid).onSnapshot(async snap=>{
    investmentsList.innerHTML = "";
    for(const doc of snap.docs){
      const inv = doc.data();
      const planDoc = await db.collection("investmentPlans").doc(inv.planId).get();
      const plan = planDoc.data() || {};

      const now = new Date();
      const expireDate = inv.expireDate?.toDate ? inv.expireDate.toDate() : new Date(inv.expireDate);
      const diffDays = Math.max(0, Math.ceil((expireDate-now)/(1000*60*60*24)));

      // Auto-expire investment
      if(inv.status==="active" && now>=expireDate){
        await db.collection("userInvestments").doc(doc.id).update({status:"expired"});
      }

      const div = document.createElement("div");
      div.className = "box";
      div.innerHTML = `
        <p><b>${plan.name || 'Plan'}</b></p>
        <p>Amount Invested: ‚Ç¶${inv.amount}</p>
        <p>Status: ${inv.status}</p>
        <p>Ends: ${expireDate.toLocaleDateString()}</p>
        <p>Days Remaining: ${diffDays}</p>
        <p>Returned: ‚Ç¶${inv.returnedAmount || 0}</p>
      `;
      investmentsList.appendChild(div);
    }
  });

  // Auto-credit investments on profit/loss
  db.collection("userInvestments")
    .where("userId","==",user.uid)
    .onSnapshot(async snap=>{
      for(const change of snap.docChanges()){
        if(change.type==="modified"){
          const inv = change.doc.data();
          if(inv.returnedAmount===0 && inv.status!=="active"){
            let credit = 0;
            if(inv.profitOrLoss==="profit") credit = inv.amount; // 100%
            else if(inv.profitOrLoss==="loss") credit = inv.amount * 0.65; // 65%

            const userRef = db.collection("users").doc(auth.currentUser.uid);
            await db.runTransaction(async tx=>{
              const userDoc = await tx.get(userRef);
              const currentBalance = userDoc.data()?.balance || 0;
              tx.update(userRef, {balance: currentBalance + credit});
              tx.update(db.collection("userInvestments").doc(change.doc.id), {returnedAmount: credit});
            });

            alert(`Investment ${inv.profitOrLoss==='profit'?'Profit':'Partial Loss'} credited: ‚Ç¶${credit}`);
          }
        }
      }
    });
});

// Bottom navigation
document.getElementById("navDashboard").onclick = ()=>{ dashboardView.style.display="block"; profileView.style.display="none"; };
document.getElementById("navProfile").onclick = ()=>{ dashboardView.style.display="none"; profileView.style.display="block"; };

// Task submission logic
async function compressImageToBase64(file, maxWidth=800, quality=0.6){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = ()=>{
      const img = new Image();
      img.src = reader.result;
      img.onload = ()=>{
        const canvas = document.createElement("canvas");
        const scale = Math.min(maxWidth/img.width,1);
        canvas.width = img.width*scale;
        canvas.height = img.height*scale;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        resolve(canvas.toDataURL("image/jpeg",quality).split(",")[1]);
      };
      img.onerror = reject;
    };
    reader.onerror = reject;
  });
}

document.addEventListener("click", async e=>{
  if(!e.target.classList.contains("uploadBtn")) return;
  const btn = e.target;
  const taskId = btn.dataset.taskId;
  const reward = parseInt(btn.dataset.reward||0);
  const input = document.querySelector(`.screenshotInput[data-task-id="${taskId}"]`);
  const status = document.querySelector(`.uploadStatus[data-task-id="${taskId}"]`);

  if(!input.files[0]) { alert("Select a screenshot first"); return; }

  btn.disabled=true;
  status.innerText="Uploading...";

  try{
    const base64 = await compressImageToBase64(input.files[0]);
    const user = auth.currentUser;
    const snap = await db.collection("task-submissions")
      .where("userId","==",user.uid)
      .where("taskId","==",taskId).get();
    if(!snap.empty){ status.innerText="You already submitted this task!"; return; }

    await db.collection("task-submissions").add({
      userId:user.uid,
      taskId,
      screenshotBase64:base64,
      status:"pending",
      reward,
      credited:false,
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    });

    status.innerText="‚úÖ Submitted successfully. Await review.";
    input.value="";
  }catch(err){
    console.error(err);
    status.innerText="‚ùå Upload failed. Try again.";
    btn.disabled=false;
  }
});
</script>
</body>
</html>
