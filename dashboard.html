<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zyppayxvest | Dashboard</title>
<style>
body { margin:0; font-family: Arial, Helvetica, sans-serif; background:#f6f8fb;}
header { background:#0a1f44; color:#fff; padding:20px; text-align:center; font-size:20px;}
.hero { background:#102f66; color:#fff; text-align:center; padding:25px 15px; border-bottom-left-radius:20px; border-bottom-right-radius:20px;}
.hero h2 { margin:0 0 10px; font-size:22px; }
.hero p { margin:0; font-size:16px; opacity:0.9; }
.container { max-width:1100px; margin:auto; padding:15px;}
.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:15px; margin-top:20px;}
.card { background:#fff; padding:18px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.05); text-align:center;}
.card h3 { font-size:14px; color:#666; margin-bottom:8px;}
.card p { font-size:20px; font-weight:bold; color:#0a1f44; margin:0;}
.actions { display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:12px; margin-top:25px;}
.actions button { padding:12px; background:#00c896; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:bold;}
.notifications { margin-top:25px; }
.notifications h3 { font-size:16px; margin-bottom:12px; color:#0a1f44;}
.notifications ul { list-style:none; padding:0; max-height:200px; overflow-y:auto; }
.notifications li { background:#fff; margin-bottom:10px; padding:12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.05);}
nav { position:fixed; bottom:0; width:100%; background:#fff; border-top:1px solid #ddd; display:flex; justify-content:space-around; padding:10px 0; }
nav a { text-decoration:none; color:#555; font-size:13px; text-align:center; }
nav a.active { color:#00c896; font-weight:bold; }
</style>
</head>
<body>

<header>Zyppayxvest Dashboard</header>

<section class="hero">
<h2>Welcome, <span id="userName">User</span>!</h2>
<p>Wallet Balance: ₦<span id="balance">0</span></p>
</section>

<div class="container">

  <div class="grid">
    <div class="card"><h3>Total Earnings</h3><p>₦<span id="earnings">0</span></p></div>
    <div class="card"><h3>Referral Bonus</h3><p>₦<span id="referralBonus">0</span></p></div>
    <div class="card"><h3>Total Referrals</h3><p><span id="referrals">0</span></p></div>
    <div class="card"><h3>Active Investment</h3><p>₦<span id="activeInvestment">0</span></p></div>
  </div>

  <div class="actions">
    <button onclick="location.href='invest.html'">Invest Now</button>
    <button id="withdrawBtn">Withdraw</button>
    <button onclick="location.href='refer.html'">Refer a Friend</button>
    <button onclick="location.href='alert.html'">Alerts</button>
  </div>

  <div class="notifications">
    <h3>Recent Activities</h3>
    <ul id="activities">
      <li>No notifications yet</li>
    </ul>
  </div>

</div>

<nav>
  <a href="dashboard.html" class="active">Home</a>
  <a href="invest.html">Invest</a>
  <a href="refer.html">Refer</a>
  <a href="alert.html">Alerts</a>
  <a href="profile.html">Profile</a>
</nav>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  collection,
  getDocs,
  updateDoc,
  addDoc,
  query,
  where,
  orderBy,
  onSnapshot,
  serverTimestamp,
  limit
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCQ8TCMUAySwLSBN3-0W1GV4XWateS1rqQ",
  authDomain: "zyppayx-69c54.firebaseapp.com",
  projectId: "zyppayx-69c54",
  storageBucket: "zyppayx-69c54.firebasestorage.app",
  messagingSenderId: "439535581166",
  appId: "1:439535581166:web:994d1c9f75bd1294ef00ff"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  const uid = user.uid;
  const userRef = doc(db, "users", uid);

  onSnapshot(userRef, (snap) => {
    if (!snap.exists()) return;
    const data = snap.data();
    document.getElementById("userName").textContent = data.name || "User";
    document.getElementById("balance").textContent = data.balance || 0;
    document.getElementById("earnings").textContent = data.totalEarnings || 0;
    document.getElementById("referralBonus").textContent = data.referralBonus || 0;
    document.getElementById("referrals").textContent = data.referrals || 0;
    document.getElementById("activeInvestment").textContent = data.activeInvestment || 0;
  });

  const investRef = collection(db, "users", uid, "investments");

  onSnapshot(investRef, async (snapshot) => {
    const now = new Date();

    for (const docSnap of snapshot.docs) {
      const inv = docSnap.data();
      if (!inv.createdAt || inv.status !== "active") continue;

      const investedAt = inv.createdAt.toDate();
      const endDate = new Date(investedAt.getTime() + inv.duration * 86400000);

      if (now >= endDate) {
        await updateDoc(doc(db, "users", uid, "investments", docSnap.id), {
          status: "matured"
        });

        const userSnap = await getDoc(userRef);
        const balance = userSnap.data()?.balance || 0;

        await updateDoc(userRef, {
          balance: balance + (inv.totalReturn || 0)
        });

        await addDoc(collection(db, "users", uid, "activities"), {
          message: `Your ${inv.title} investment has matured.`,
          createdAt: serverTimestamp()
        });
      }
    }
  });

  const activitiesRef = collection(db, "users", uid, "activities");
  const q = query(activitiesRef, orderBy("createdAt", "desc"), limit(5));

  onSnapshot(q, (snapshot) => {
    const list = document.getElementById("activities");
    list.innerHTML = "";

    if (snapshot.empty) {
      list.innerHTML = "<li>No notifications yet</li>";
      return;
    }

    snapshot.forEach((doc) => {
      const li = document.createElement("li");
      li.textContent = doc.data().message;
      list.appendChild(li);
    });
  });

  const withdrawalRef = collection(db, "withdrawals");
  const q2 = query(withdrawalRef, where("userId", "==", uid));

  onSnapshot(q2, (snapshot) => {
    snapshot.forEach(async (docW) => {
      const w = docW.data();
      if (w.status === "approved" && !w.notified) {
        await addDoc(collection(db, "users", uid, "activities"), {
          message: `Your withdrawal of ₦${w.amount} has been approved.`,
          createdAt: serverTimestamp()
        });
        await updateDoc(doc(db, "withdrawals", docW.id), { notified: true });
      }
    });
  });
});

document.getElementById("withdrawBtn").onclick = () => {
  window.location.href = "withdraw.html";
};
</script>

</body>
</html>