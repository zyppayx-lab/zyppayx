<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Deposit – Zyppayx</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background:#000; color:#eee; font-family:Arial; margin:0; display:flex; justify-content:center; align-items:center; height:100vh; }
    .container { max-width:400px; width:100%; padding:20px; background:#111; border-radius:12px; text-align:center; }
    h2 { color:#bb86fc; }
    input { width:100%; padding:12px; margin-top:10px; border-radius:8px; border:1px solid #444; background:#222; color:#eee; }
    button { width:100%; padding:14px; margin-top:15px; background:#bb86fc; color:#000; border:none; border-radius:8px; font-size:16px; cursor:pointer; }
    button:hover { opacity:0.9; }
    .fee { margin-top:8px; font-size:14px; color:#aaa; }
  </style>

  <script src="https://js.paystack.co/v1/inline.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
  <h2>Deposit Funds</h2>
  <input type="number" id="amount" placeholder="Enter amount (₦)">
  <div class="fee" id="feeText"></div>
  <button id="depositBtn">Proceed to Paystack</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDaQrSeEcCIVOtQJwiEeS_86w11Hn-ITh8",
  authDomain: "zyppayx-57fbf.firebaseapp.com",
  projectId: "zyppayx-57fbf"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const amountInput = document.getElementById("amount");
const feeText = document.getElementById("feeText");
const depositBtn = document.getElementById("depositBtn");
let currentUser = null;

auth.onAuthStateChanged(user => {
  if(!user) location.href="index.html";
  else currentUser = user;
});

amountInput.addEventListener("input", () => {
  const amt = Number(amountInput.value);
  feeText.textContent = amt ? `Transaction Fee (5%): ₦${(amt * 0.05).toFixed(2)}` : "";
});

depositBtn.addEventListener("click", () => {
  if(!currentUser) return;

  const amount = Number(amountInput.value);
  if(!amount || amount < 100) return alert("Minimum deposit is ₦100");

  const fee = Number((amount * 0.05).toFixed(2));
  const total = amount + fee;

  PaystackPop.setup({
    key: "pk_live_d52baea87b2c4e49b110aa5cda32260b33b0cb35",
    email: currentUser.email,
    amount: total * 100,
    currency: "NGN",
    callback: async function(response){
      const userRef = db.collection("users").doc(currentUser.uid);

      // Auto-credit user's balance (only deposit amount, fee stays with you)
      await db.runTransaction(async tx=>{
        const snap = await tx.get(userRef);
        const balance = snap.data()?.balance || 0;
        tx.update(userRef, { balance: balance + amount });
      });

      // Save deposit record
      await db.collection("deposits").add({
        userId: currentUser.uid,
        email: currentUser.email,
        amount,
        fee,
        totalPaid: total,
        reference: response.reference,
        status:"completed",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      location.href="dashboard.html";
    },
    onClose: function(){ alert("Payment cancelled"); }
  }).openIframe();
});
</script>

</body>
</html>
