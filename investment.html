<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Invest | Zyppayx</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{background:#000;color:#eee;font-family:Arial;margin:0}
.box{background:#111;margin:15px;padding:20px;border-radius:12px}
h2{color:#bb86fc}
select,input,button{width:100%;padding:12px;margin-top:10px;border-radius:8px;border:none}
button{background:#bb86fc;color:#000;font-weight:bold;cursor:pointer}
button:hover{opacity:.9}
.plan-img{width:100%;border-radius:12px;margin-top:10px}
.small{font-size:13px;color:#bbb;margin-top:5px}
.bottom-nav{position:fixed;bottom:0;width:100%;background:#111;display:flex;justify-content:space-around;padding:10px 0;border-top:1px solid #333}
.bottom-nav button{flex:1;margin:0 5px}
</style>
</head>
<body>

<div class="box">
  <h2>Start Investment</h2>

  <select id="planSelect">
    <option value="">Select Investment Plan</option>
  </select>

  <img id="planImg" class="plan-img" style="display:none">

  <div class="small" id="planInfo"></div>

  <input type="number" id="amount" placeholder="Enter amount (‚Ç¶)">

  <button id="investBtn">Invest Now</button>
</div>

<div class="bottom-nav">
  <button onclick="location.href='dashboard.html'">üè†</button>
  <button onclick="location.href='investment.html'">üí∞</button>
  <button onclick="location.href='profile.html'">üë§</button>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyDaQrSeEcCIVOtQJwiEeS_86w11Hn-ITh8",
  authDomain: "zyppayx-57fbf.firebaseapp.com",
  projectId: "zyppayx-57fbf"
});

const auth = firebase.auth();
const db = firebase.firestore();

const planSelect = document.getElementById("planSelect");
const planImg = document.getElementById("planImg");
const planInfo = document.getElementById("planInfo");
const amountInput = document.getElementById("amount");

let plans = {};

// Load investment plans
db.collection("investmentPlans").onSnapshot(snap=>{
  planSelect.innerHTML = `<option value="">Select Investment Plan</option>`;
  snap.forEach(doc=>{
    plans[doc.id] = doc.data();
    planSelect.innerHTML += `<option value="${doc.id}">${doc.data().title}</option>`;
  });
});

// Show plan details when selected
planSelect.onchange = ()=>{
  const plan = plans[planSelect.value];
  if(!plan) return;

  planImg.src = plan.image;
  planImg.style.display = "block";

  planInfo.innerHTML = `
    Min: ‚Ç¶${plan.minAmount}<br>
    Max: ‚Ç¶${plan.maxAmount}<br>
    Duration: ${plan.durationDays} days<br>
    Profit: ${plan.profitPercent || 100}% | Loss: ${plan.lossPercent || 65}%
  `;
};

// Invest now
document.getElementById("investBtn").onclick = async ()=>{
  const user = auth.currentUser;
  if(!user) return alert("Please login");

  const planId = planSelect.value;
  const plan = plans[planId];
  const amount = Number(amountInput.value);

  if(!plan) return alert("Select a plan");
  if(amount < plan.minAmount || amount > plan.maxAmount)
    return alert("Invalid amount");

  const userRef = db.collection("users").doc(user.uid);

  try{
    await db.runTransaction(async tx=>{
      const userDoc = await tx.get(userRef);
      const balance = userDoc.data().balance || 0;
      if(balance < amount) throw "Insufficient balance";

      const startDate = new Date();
      const endDate = new Date();
      endDate.setDate(endDate.getDate() + plan.durationDays);

      // Deduct balance
      tx.update(userRef, { balance: balance - amount });

      // Add investment
      const investRef = db.collection("userInvestments").doc();
      tx.set(investRef, {
        userId: user.uid,
        planId,
        amount,
        profitPercent: plan.profitPercent || 100,
        lossPercent: plan.lossPercent || 65,
        status: "active",
        result: null,
        credited: false,
        startDate: firebase.firestore.Timestamp.fromDate(startDate),
        endDate: firebase.firestore.Timestamp.fromDate(endDate),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });

    alert("Investment started successfully!");
    location.href="dashboard.html";

  }catch(err){
    alert(err);
  }
};

// Auto-expire investments and credit balance
auth.onAuthStateChanged(async user=>{
  if(!user) return;

  db.collection("userInvestments")
    .where("userId","==",user.uid)
    .where("status","==","active")
    .onSnapshot(async snap=>{
      const now = new Date();
      for(const doc of snap.docs){
        const inv = doc.data();
        const endDate = inv.endDate?.toDate();
        if(endDate && now >= endDate && !inv.credited){
          const userRef = db.collection("users").doc(user.uid);
          let creditAmount = inv.amount;
          let message = "";

          // Here, decide profit or loss (you manually update 'result' field)
          if(inv.result === "profit") {
            creditAmount = inv.amount * (inv.profitPercent/100);
            message = "Your investment ended in PROFIT!";
          } else if(inv.result === "loss") {
            creditAmount = inv.amount * (inv.lossPercent/100);
            message = "Your investment ended in LOSS!";
          } else continue; // skip if not decided yet

          await db.runTransaction(async tx=>{
            const userDoc = await tx.get(userRef);
            const currentBalance = userDoc.data().balance || 0;
            tx.update(userRef,{ balance: currentBalance + creditAmount });
            tx.update(doc.ref, { credited: true, status: "completed" });
            // Add to history collection
            tx.set(db.collection("userInvestmentHistory").doc(),{
              userId: user.uid,
              planId: inv.planId,
              amount: inv.amount,
              creditedAmount: creditAmount,
              result: inv.result,
              startDate: inv.startDate,
              endDate: inv.endDate,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          });

          alert(message + ` ‚Ç¶${creditAmount} credited to your balance.`);
        }
      }
    });
});
</script>
</body>
</html>
