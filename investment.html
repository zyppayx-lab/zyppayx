<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Zyppayx Investments</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial, sans-serif; background: #000; margin: 0; color: #eee; }
#plansContainer { padding: 15px; }
.investment-card { background: #111; border-radius: 12px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 0 10px #222; }
.investment-card img { width: 100%; height: 180px; object-fit: cover; }
.investment-card .card-body { padding: 15px; }
.investment-card h3 { color: #bb86fc; margin: 0 0 10px 0; font-size: 1.2em; }
.investment-card p { margin: 5px 0; font-size: 0.95em; }
.investment-card .highlight { color: #00fff0; font-weight: bold; }
.investment-card .invest-btn { display: block; width: 100%; padding: 12px; margin-top: 10px; background: #bb86fc; color: #000; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; }
.investment-card .invest-btn:hover { opacity: 0.9; }
.countdown { margin-top: 8px; font-size: 0.9em; color: #bb86fc; }
.bottom-nav { position: fixed; bottom: 0; width: 100%; background: #111; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #333; }
.bottom-nav button { flex: 1; margin: 0 5px; background: #222; color: #eee; border: none; border-radius: 8px; padding: 10px; cursor: pointer; }
.bottom-nav button:hover { background: #333; }
</style>

<script src="https://js.paystack.co/v1/inline.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>

<div id="plansContainer"></div>

<div class="bottom-nav">
  <button id="navDashboard">üè†</button>
  <button onclick="location.href='investment.html'">üí∞</button>
  <button id="navProfile">üë§</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDaQrSeEcCIVOtQJwiEeS_86w11Hn-ITh8",
  authDomain: "zyppayx-57fbf.firebaseapp.com",
  projectId: "zyppayx-57fbf",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const PAYSTACK_KEY = "pk_live_d52baea87b2c4e49b110aa5cda32260b33b0cb35"; // Your live key
const plansContainer = document.getElementById("plansContainer");

auth.onAuthStateChanged(async user => {
  if(!user) location.href="index.html";

  const currentUserId = user.uid;
  const currentUserEmail = user.email;

  // Load active investment plans
  db.collection("investmentPlans").orderBy("createdAt","desc").onSnapshot(snap => {
    plansContainer.innerHTML = "";
    if(snap.empty) {
      plansContainer.innerHTML = "<p style='text-align:center; color:#bbb;'>No investment plans available</p>";
      return;
    }

    snap.forEach(doc => {
      const plan = doc.data();
      if(plan.status !== "active") return;

      const min = plan.minAmount || 0;
      const max = plan.maxAmount || 0;
      const duration = plan.durationDays || 1;
      const profit = plan.profitPercent || 0;
      const loss = plan.lossPercent || 0;

      const card = document.createElement("div");
      card.className = "investment-card";
      card.innerHTML = `
        <img src="${plan.imgUrl || 'https://via.placeholder.com/400x200'}" alt="${plan.name}">
        <div class="card-body">
          <h3>${plan.name}</h3>
          <p>Amount: <span class="highlight">‚Ç¶${min} - ‚Ç¶${max}</span></p>
          <p>Daily Earnings: <span class="highlight">‚Ç¶${(min*profit/100).toLocaleString()}</span></p>
          <p>Duration: <span class="highlight">${duration} days</span></p>
          <p>Total Returns: <span class="highlight">‚Ç¶${(min*(1+profit/100)*duration).toLocaleString()}</span></p>
          <input type="number" placeholder="Enter Amount" min="${min}" max="${max}" class="investAmount" data-plan-id="${doc.id}">
          <button class="invest-btn" data-plan-id="${doc.id}" data-min="${min}" data-max="${max}" data-duration="${duration}" data-profit="${profit}" data-loss="${loss}">Invest Now</button>
          <p class="countdown" id="countdown-${doc.id}"></p>
        </div>
      `;
      plansContainer.appendChild(card);
    });
  });

  // Handle Paystack investment
  document.addEventListener("click", async e => {
    if(!e.target.classList.contains("invest-btn")) return;

    const btn = e.target;
    const planId = btn.dataset.planId;
    const min = parseFloat(btn.dataset.min);
    const max = parseFloat(btn.dataset.max);
    const duration = parseInt(btn.dataset.duration);
    const profit = parseFloat(btn.dataset.profit);
    const loss = parseFloat(btn.dataset.loss);

    const input = document.querySelector(`.investAmount[data-plan-id="${planId}"]`);
    let amount = parseFloat(input.value);

    if(!amount || amount < min || amount > max) {
      alert(`Enter amount between ‚Ç¶${min} and ‚Ç¶${max}`);
      return;
    }

    // Paystack payment
    PaystackPop.setup({
      key: PAYSTACK_KEY,
      email: currentUserEmail,
      amount: amount * 100,
      currency: "NGN",
      callback: async () => {
        // Record investment in Firebase
        const startDate = new Date();
        const expireDate = new Date();
        expireDate.setDate(startDate.getDate() + duration);

        await db.collection("userInvestments").add({
          userId: currentUserId,
          planId,
          amount,
          duration,
          profitPercent: profit,
          lossPercent: loss,
          startDate: firebase.firestore.FieldValue.serverTimestamp(),
          expireDate,
          status: "active",
          returnedAmount: 0,
          profitOrLoss: "" // You will manually set this later
        });

        alert("Investment started successfully!");
        input.value = "";
        startCountdown(expireDate, document.getElementById(`countdown-${planId}`));
      },
      onClose: () => alert("Payment cancelled")
    }).openIframe();
  });

  // Auto-credit when profit/loss is set
  db.collection("userInvestments")
    .where("userId", "==", currentUserId)
    .onSnapshot(async snap => {
      for(const change of snap.docChanges()){
        if(change.type === "modified"){
          const inv = change.doc.data();
          if(inv.profitOrLoss && inv.status === "active" && inv.returnedAmount === 0){
            const userRef = db.collection("users").doc(currentUserId);
            const userDoc = await userRef.get();
            const currentBalance = userDoc.data()?.balance || 0;

            let credit = inv.amount;
            if(inv.profitOrLoss === "profit") credit += (inv.amount * (inv.profitPercent||0)/100);
            else if(inv.profitOrLoss === "loss") credit -= (inv.amount * (inv.lossPercent||0)/100);

            await userRef.update({ balance: currentBalance + credit });
            await db.collection("userInvestments").doc(change.doc.id).update({ returnedAmount: credit, status: "completed" });

            alert(`Investment ${inv.profitOrLoss.toUpperCase()} credited: ‚Ç¶${credit}`);
          }
        }
      }
    });

  // Countdown
  function startCountdown(expireDate, element){
    function updateCountdown(){
      const now = new Date();
      let diff = expireDate - now;
      if(diff <= 0){
        element.innerText = "Investment ended";
        clearInterval(interval);
        return;
      }
      const days = Math.floor(diff/(1000*60*60*24));
      const hours = Math.floor((diff/(1000*60*60))%24);
      const mins = Math.floor((diff/(1000*60))%60);
      const secs = Math.floor((diff/1000)%60);
      element.innerText = `Time Remaining: ${days}d ${hours}h ${mins}m ${secs}s`;
    }
    updateCountdown();
    const interval = setInterval(updateCountdown, 1000);
  }

  // Bottom nav
  document.getElementById("navDashboard").onclick = ()=>{ location.href='dashboard.html'; };
  document.getElementById("navProfile").onclick = ()=>{ location.href='dashboard.html'; };
});
</script>
</body>
</html>
