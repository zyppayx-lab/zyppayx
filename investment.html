<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Zyppayx Investments</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial; background: #000; margin: 0; color: #eee; }
.box { background: #111; margin: 15px; padding: 20px; border-radius: 12px; }
h2,h3 { color: #bb86fc; margin-bottom: 10px; }
button { background: #bb86fc; color: #000; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; margin: 5px 5px 0 0; }
button:hover { opacity: 0.9; }
.investment-card { display: flex; flex-direction: column; gap: 10px; border-bottom: 1px solid #333; padding: 15px 0; }
.investment-card img { width: 100%; border-radius: 12px; object-fit: cover; }
.countdown { color: #bb86fc; margin-top: 5px; }
.bottom-nav { position: fixed; bottom: 0; width: 100%; background: #111; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #333; }
.bottom-nav button { flex: 1; margin: 0 5px; }
</style>
<script src="https://js.paystack.co/v1/inline.js"></script>
</head>
<body>

<div id="plansContainer"></div>

<div class="bottom-nav">
  <button id="navDashboard">üè†</button>
  <button onclick="location.href='investment.html'">üí∞</button>
  <button id="navProfile">üë§</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDaQrSeEcCIVOtQJwiEeS_86w11Hn-ITh8",
  authDomain: "zyppayx-57fbf.firebaseapp.com",
  projectId: "zyppayx-57fbf",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const PAYSTACK_KEY = "pk_live_d52baea87b2c4e49b110aa5cda32260b33b0cb35";
const plansContainer = document.getElementById("plansContainer");

auth.onAuthStateChanged(async user => {
  if(!user) location.href="index.html";

  const currentUserId = user.uid;
  const currentUserEmail = user.email;

  // Load investment plans
  db.collection("investmentPlans").orderBy("createdAt","desc").onSnapshot(snap=>{
    plansContainer.innerHTML = "";
    snap.forEach(doc=>{
      const plan = doc.data();
      if(plan.status !== "active") return;

      const card = document.createElement("div");
      card.className = "box investment-card";
      card.innerHTML = `
        <img src="${plan.imgUrl}" alt="${plan.name}">
        <h3>${plan.name}</h3>
        <p>Amount: ‚Ç¶${plan.minAmount} - ‚Ç¶${plan.maxAmount}</p>
        <p>Duration: ${plan.durationDays} days</p>
        <p>Profit: ${plan.profitPercent || 0}% | Loss: ${plan.lossPercent || 0}%</p>
        <input type="number" placeholder="Enter Amount" min="${plan.minAmount}" max="${plan.maxAmount}" class="investAmount" data-plan-id="${doc.id}">
        <button class="investBtn" data-plan-id="${doc.id}" data-min="${plan.minAmount}" data-max="${plan.maxAmount}" data-duration="${plan.durationDays}" data-profit="${plan.profitPercent || 0}" data-loss="${plan.lossPercent || 0}">Invest</button>
        <p class="countdown" id="countdown-${doc.id}"></p>
      `;
      plansContainer.appendChild(card);
    });
  });

  // Handle investment clicks with Paystack
  document.addEventListener("click", async e=>{
    if(!e.target.classList.contains("investBtn")) return;

    const btn = e.target;
    const planId = btn.dataset.planId;
    const min = parseFloat(btn.dataset.min);
    const max = parseFloat(btn.dataset.max);
    const duration = parseInt(btn.dataset.duration);
    const profit = parseFloat(btn.dataset.profit);
    const loss = parseFloat(btn.dataset.loss);

    const input = document.querySelector(`.investAmount[data-plan-id="${planId}"]`);
    let amount = parseFloat(input.value);

    if(!amount || amount < min || amount > max) { alert(`Enter amount between ‚Ç¶${min} and ‚Ç¶${max}`); return; }

    // Paystack payment
    PaystackPop.setup({
      key: PAYSTACK_KEY,
      email: currentUserEmail,
      amount: amount * 100,
      currency: "NGN",
      callback: async () => {
        const startDate = new Date();
        const expireDate = new Date();
        expireDate.setDate(startDate.getDate() + duration);

        await db.collection("userInvestments").add({
          userId: currentUserId,
          planId,
          amount,
          duration,
          profitPercent: profit,
          lossPercent: loss,
          startDate: firebase.firestore.FieldValue.serverTimestamp(),
          expireDate,
          status: "active",
          returnedAmount: 0,
          profitOrLoss: "" // manually set later
        });

        alert("Investment started!");
        input.value = "";
        startCountdown(expireDate, document.getElementById(`countdown-${planId}`));
      },
      onClose: () => alert("Payment cancelled")
    }).openIframe();
  });

  // Auto-credit after profit/loss is manually set
  db.collection("userInvestments")
    .where("userId", "==", currentUserId)
    .onSnapshot(async snap => {
      for(const change of snap.docChanges()){
        if(change.type === "modified"){
          const inv = change.doc.data();
          if(inv.profitOrLoss && inv.status === "active" && inv.returnedAmount === 0){
            const userRef = db.collection("users").doc(currentUserId);
            const userDoc = await userRef.get();
            const currentBalance = userDoc.data()?.balance || 0;

            let credit = inv.amount;
            if(inv.profitOrLoss === "profit") credit += (inv.amount * (inv.profitPercent||0)/100);
            else if(inv.profitOrLoss === "loss") credit -= (inv.amount * (inv.lossPercent||0)/100);

            await userRef.update({ balance: currentBalance + credit });
            await db.collection("userInvestments").doc(change.doc.id).update({ returnedAmount: credit, status: "completed" });

            alert(`Investment ${inv.profitOrLoss.toUpperCase()} credited: ‚Ç¶${credit}`);
          }
        }
      }
    });

  // Countdown function
  function startCountdown(expireDate, element){
    function updateCountdown(){
      const now = new Date();
      let diff = expireDate - now;
      if(diff <= 0){
        element.innerText = "Investment ended";
        clearInterval(interval);
        return;
      }
      const days = Math.floor(diff/(1000*60*60*24));
      const hours = Math.floor((diff/(1000*60*60))%24);
      const mins = Math.floor((diff/(1000*60))%60);
      const secs = Math.floor((diff/1000)%60);
      element.innerText = `Time Remaining: ${days}d ${hours}h ${mins}m ${secs}s`;
    }
    updateCountdown();
    const interval = setInterval(updateCountdown, 1000);
  }

});

// Bottom navigation logic same as dashboard
document.getElementById("navDashboard").onclick = ()=>{ location.href='dashboard.html'; };
document.getElementById("navProfile").onclick = ()=>{ location.href='dashboard.html'; }; // no separate profile page
</script>
</body>
</html>
